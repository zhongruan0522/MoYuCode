# 会话管理重构需求文档

## 概述

重构 A2A 会话管理逻辑，实现后台会话执行、会话与项目绑定、SignalR 实时推送等功能。

---

## 用户故事

### 1. 会话持久化

**作为** 开发者  
**我希望** 会话消息能够持久化存储  
**以便** 关闭应用后重新打开能看到历史对话记录

#### 验收标准
- 1.1 创建会话实体（SessionEntity），包含 Id、ProjectId、CreatedAtUtc、UpdatedAtUtc 等字段
- 1.2 创建会话消息实体（SessionMessageEntity），包含 Id、SessionId、Role、Content、CreatedAtUtc 等字段
- 1.3 会话和消息数据存储在 SQLite 数据库中
- 1.4 支持按会话 ID 查询历史消息，支持分页

### 2. 会话与项目绑定

**作为** 开发者  
**我希望** 每个项目能记录当前活跃会话  
**以便** 下次打开项目时能自动加载上次的对话

#### 验收标准
- 2.1 ProjectEntity 增加 CurrentSessionId 字段，记录当前活跃会话
- 2.2 创建新会话时自动更新项目的 CurrentSessionId
- 2.3 打开项目时自动加载 CurrentSessionId 对应的会话
- 2.4 支持切换到历史会话

### 3. SignalR 实时推送

**作为** 开发者  
**我希望** 使用 SignalR 接收实时消息  
**以便** 获得更稳定的实时通信体验

#### 验收标准
- 3.1 创建 ChatHub，支持客户端加入/离开会话组
- 3.2 A2A 任务执行时通过 SignalR 推送消息到对应会话组
- 3.3 支持推送多种消息类型：文本增量、工具调用、状态更新、Token 使用量等
- 3.4 客户端断线重连后能自动重新加入会话组

### 4. 后台会话执行

**作为** 开发者  
**我希望** A2A 对话在后台持续执行  
**以便** 即使关闭前端页面，对话也能继续进行

#### 验收标准
- 4.1 A2A 任务启动后在后台独立运行，不依赖前端连接
- 4.2 任务执行过程中的消息实时保存到数据库
- 4.3 前端重新连接时能获取任务执行期间的所有消息
- 4.4 支持查询任务当前状态（运行中/已完成/已取消/失败）

### 5. 会话历史管理

**作为** 开发者  
**我希望** 能够管理会话历史  
**以便** 查看和切换不同的对话

#### 验收标准
- 5.1 提供 API 获取项目的所有会话列表
- 5.2 支持创建新会话
- 5.3 支持删除会话
- 5.4 前端显示会话列表，支持切换会话

### 6. 运行中会话管理

**作为** 开发者  
**我希望** 能够查看所有运行中的后台会话  
**以便** 监控任务执行状态并在多个会话间切换

#### 验收标准
- 6.1 提供 API 获取所有运行中的会话列表（跨项目）
- 6.2 运行中会话显示状态标识（运行中/已完成/失败/已取消）
- 6.3 支持从运行中会话列表快速切换到对应会话
- 6.4 支持在当前项目创建新的后台会话（不影响现有运行中会话）
- 6.5 前端显示运行中会话指示器，显示当前有多少个任务在后台运行
- 6.6 支持查看任意运行中会话的实时输出（即使不是当前活跃会话）

---

## 非功能需求

### 性能
- 消息推送延迟 < 100ms
- 历史消息加载支持分页，每页最多 50 条

### 可靠性
- SignalR 断线自动重连
- 消息不丢失，即使客户端临时断开

### 兼容性
- 保持现有 A2A JSON-RPC API 兼容性
- 支持渐进式迁移

---

## 技术约束

- 后端：ASP.NET Core (.NET 10)
- 数据库：SQLite（使用现有 JsonDataStore 模式）
- 前端：React + TypeScript
- 实时通信：SignalR
